/******************************************************************************
 * NanoH7 - UAV firmware base on RT-Thread
 * Copyright (C) 2023 - 2024 Althrone <mail>
 * 
 * @file    rt-thread\bsp\stm32\rcf-nano-h7\protocol\crsf\crfs.c
 * 
 * ref: Specification of <some UM RM or Datasheet>
 *****************************************************************************/

/******************************************************************************
 * includes
 *****************************************************************************/

#include "crfs.h"

/******************************************************************************
 * private macros
 *****************************************************************************/

/******************************************************************************
 * pubilc variables
 *****************************************************************************/

/******************************************************************************
 * private types
 *****************************************************************************/

crsf_channels_s crsf_channels_value __attribute__((section(".test_data")));

/******************************************************************************
 * private variables
 *****************************************************************************/

extern CRC_HandleTypeDef hcrc;

/******************************************************************************
 * private functions declaration
 *****************************************************************************/

/******************************************************************************
 * pubilc functions definition
 *****************************************************************************/

void crfs_decode(rt_uint8_t* pbuf,rt_uint32_t size)
{
    //检查开头是不是0xC8
    if(pbuf[0]!=0xC8)
        return;

    //获取假定的长度值
    rt_uint8_t len=pbuf[1];
    rt_uint32_t crc;

    //计算CRC
    crc=HAL_CRC_Calculate(&hcrc,&pbuf[2],len-1);
    if(crc!=pbuf[len])
        return;

    switch ((CrfsPacketTypesEnum)pbuf[2])
    {
    case CRSF_FRAMETYPE_RC_CHANNELS_PACKED:

        rt_memcpy(&crsf_channels_value,&pbuf[3],sizeof(crsf_channels_value));
        break;
    
    default:
        break;
    }
}

/******************************************************************************
 * private functions definition
 *****************************************************************************/
